# Failure Notification Workflow
# Monitors workflow failures and creates issues for tracking

name: Notify Failures

on:
  workflow_run:
    workflows:
      - 'CI'
      - 'Release Please'
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  notify-failure:
    name: Create Failure Issue
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Get Workflow Run Details
        id: details
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            
            // Get the failed jobs
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
            });
            
            const failedJobs = jobs.jobs.filter(job => job.conclusion === 'failure');
            const failedJobNames = failedJobs.map(job => job.name).join(', ');
            
            core.setOutput('workflow_name', run.name);
            core.setOutput('run_id', run.id);
            core.setOutput('run_url', run.html_url);
            core.setOutput('branch', run.head_branch);
            core.setOutput('sha', run.head_sha.substring(0, 7));
            core.setOutput('actor', run.actor.login);
            core.setOutput('failed_jobs', failedJobNames);

      - name: Check for Existing Issue
        id: existing
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ steps.details.outputs.workflow_name }}';
            const branch = '${{ steps.details.outputs.branch }}';
            
            // Search for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes(workflowName) && 
              issue.title.includes(branch)
            );
            
            if (existingIssue) {
              core.setOutput('issue_number', existingIssue.number);
              core.setOutput('exists', 'true');
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Create New Issue
        if: steps.existing.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ CI Failure: ${{ steps.details.outputs.workflow_name }} on ${{ steps.details.outputs.branch }}`;
            
            const body = `## Workflow Failure

| Property | Value |
|----------|-------|
| **Workflow** | ${{ steps.details.outputs.workflow_name }} |
| **Branch** | \`${{ steps.details.outputs.branch }}\` |
| **Commit** | \`${{ steps.details.outputs.sha }}\` |
| **Triggered by** | @${{ steps.details.outputs.actor }} |
| **Failed Jobs** | ${{ steps.details.outputs.failed_jobs }} |

### Run Details
ðŸ”— [View Workflow Run](${{ steps.details.outputs.run_url }})

### Possible Causes
- Linting errors (ESLint, Prettier, markdownlint)
- Test failures
- Security vulnerabilities in dependencies
- Build/packaging issues

### Resolution Steps
1. Check the workflow logs for detailed error messages
2. Run \`npm run validate\` locally to reproduce
3. Fix the issues and push a new commit
4. This issue will be auto-closed when the workflow passes

---
*This issue was automatically created by the failure notification workflow.*
`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci-failure', 'automated']
            });

      - name: Update Existing Issue
        if: steps.existing.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.existing.outputs.issue_number }};
            
            const comment = `## Another Failure Detected

| Property | Value |
|----------|-------|
| **Run** | [#${{ steps.details.outputs.run_id }}](${{ steps.details.outputs.run_url }}) |
| **Commit** | \`${{ steps.details.outputs.sha }}\` |
| **Triggered by** | @${{ steps.details.outputs.actor }} |
| **Failed Jobs** | ${{ steps.details.outputs.failed_jobs }} |
| **Time** | ${new Date().toISOString()} |

*The CI is still failing on this branch.*
`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

  auto-close-on-success:
    name: Auto-close Issues on Success
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Close Related Issues
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const branch = context.payload.workflow_run.head_branch;
            
            // Find open CI failure issues for this workflow/branch
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
            });
            
            for (const issue of issues) {
              if (issue.title.includes(workflowName) && issue.title.includes(branch)) {
                // Add resolution comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `## âœ… Resolved

The workflow **${workflowName}** is now passing on branch \`${branch}\`.

ðŸ”— [View Successful Run](${context.payload.workflow_run.html_url})

*Auto-closing this issue.*`
                });
                
                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed'
                });
                
                console.log(`Closed issue #${issue.number}`);
              }
            }
